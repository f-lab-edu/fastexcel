# 다중 스레드 엑셀 쓰기 최적화 실험 결과 분석

## 실험 결과 요약

실험에서 얻은 결과는 예상과 달리 다중 스레드 사용이 성능 향상으로 이어지지 않았습니다:

| 스레드 수 | 평균 실행 시간(ms) | 평균 메모리 사용량(MB) |
|----------|-----------------|-------------------|
| 1        | 40,829          | 3,667             |
| 2        | 44,255          | 1,999             |
| 3        | 43,319          | 884               |
| 5        | 42,618          | 1,031             |

### 주요 특이사항

1. **역설적인 성능 저하**: 스레드 수 증가에 따라 성능이 향상되지 않고 오히려 감소
2. **메모리 효율성 개선**: 다중 스레드 사용 시 메모리 사용량이 크게 감소

## 실패 원인 분석

### 1. 동기화 오버헤드

FastExcel 라이브러리는 내부적으로 스레드 안전성을 보장하기 위해 암시적 동기화를 수행할 가능성이 높습니다. 여러 스레드가 동시에 Worksheet 객체에 접근할 때 발생하는 락(lock) 경쟁이 성능 저하의 주요 원인으로 추정됩니다. 스레드가 많아질수록 이러한 동기화 비용이 증가합니다.

### 2. XML 구조 직렬화 제약

엑셀 파일은 내부적으로 XML 기반 구조를 가지고 있으며, 이 구조의 생성이 본질적으로 순차적일 가능성이 높습니다. 여러 스레드에서 동시에 셀을 쓰려고 할 때, 최종 XML 문서를 구성하기 위한 직렬화 과정이 병목 지점이 될 수 있습니다.

### 3. I/O 병목

다중 스레드가 메모리 내 연산 속도를 향상시키더라도, 최종 파일 쓰기는 디스크 I/O에 의해 제한됩니다. 디스크 쓰기 작업은 본질적으로 순차적이므로, 계산 병렬화의 이점이 상쇄될 수 있습니다.

### 4. 큐 관리 오버헤드

데이터 생성과 소비 사이의 큐 관리(삽입, 제거, 크기 모니터링)에 드는 오버헤드가 단일 스레드 접근법보다 더 큰 비용을 발생시켰을 수 있습니다. 특히 ConcurrentLinkedQueue의 원자적 연산들이 추가 지연을 초래했을 가능성이 있습니다.

### 5. 컨텍스트 스위칭 비용

다중 스레드 환경에서는 CPU가 서로 다른 스레드 간 컨텍스트 스위칭을 수행해야 합니다. 이 과정은 캐시 미스와 같은 부수적인 비용을 발생시켜 전체적인 성능 저하로 이어질 수 있습니다.

## 개선 방향

### 1. 워크시트 수준의 병렬화

셀 단위가 아닌 더 큰 단위(예: 워크시트별)로 병렬화하는 전략을 고려할 수 있습니다. 각 스레드가 독립적인 워크시트에 기록하면 동기화 오버헤드를 줄일 수 있습니다.

### 2. 배치 처리 최적화

개별 셀 단위가 아닌 행 또는 열 단위의 배치 처리로 전환하여 FastExcel API 호출 횟수를 줄이는 방법을 고려해볼 수 있습니다.

### 3. 메모리 버퍼 최적화

다중 스레드에서 관찰된 메모리 사용량 감소는 흥미로운 발견입니다. 이것을 활용하여 더 큰 데이터셋을 효율적으로 처리하는 방법을 모색할 필요가 있습니다.

### 4. 라이브러리 내부 구조 분석

FastExcel 라이브러리의 내부 구현을 더 깊이 분석하여 병렬화에 적합한 지점을 식별하거나, 대안적인 라이브러리를 고려할 수 있습니다.

## 결론

이 실험은 예상과 달리 다중 스레드 접근법이 엑셀 파일 쓰기 성능을 향상시키지 않았음을 보여줍니다. 이는 FastExcel 라이브러리가 내부적으로 순차적 처리를 선호하거나 스레드 안전성을 보장하기 위한 메커니즘이 병렬 처리의 이점을 상쇄한다는 것을 시사합니다.

하지만 다중 스레드 접근법이 메모리 사용량을 크게 줄인다는 점은 주목할 만한 발견입니다. 대용량 데이터에서는 이러한 메모리 효율성이 중요한 이점이 될 수 있으므로, 더 큰 데이터셋(원래 계획된 1400만 행)에서의 추가 실험이 필요할 것으로 판단됩니다.
